// @ts-nocheck
let currentEvaluationData=null,provincesData=[];function setupEventHandlers(){$("#evaluationForm").on("submit",(function(o){o.preventDefault(),submitEvaluation()})),$("#quickEstimateForm").on("submit",(function(o){o.preventDefault(),submitQuickEstimate()})),$(".nav-link").on("click",(function(o){o.preventDefault();const t=$(this).attr("href");$("html, body").animate({scrollTop:$(t).offset().top-80},800),$(".nav-link").removeClass("active"),$(this).addClass("active")}))}function checkOllamaStatus(){$.ajax({url:"/api/check-ollama",method:"GET",success:function(o){const t=$("#ollamaStatus");o.connected?(t.removeClass("disconnected checking").addClass("connected"),t.find("span").text("AI เชื่อมต่อแล้ว"),o.models&&o.models.length>0&&console.log("Available Ollama models:",o.models)):(t.removeClass("connected checking").addClass("disconnected"),t.find("span").text("Ollama ไม่เชื่อมต่อ"))},error:function(){const o=$("#ollamaStatus");o.removeClass("connected checking").addClass("disconnected"),o.find("span").text("Ollama ไม่เชื่อมต่อ")}})}function loadProvinces(){$.ajax({url:"/api/provinces",method:"GET",success:function(o){if(o.success){provincesData=o.provinces;let t='<option value="">เลือกจังหวัด</option>';const e={"กลาง":[],"เหนือ":[],"อีสาน":[],"ใต้":[]};provincesData.forEach((function(o){e[o.region].push(o)}));for(const o in e)e[o].length>0&&(t+=`<optgroup label="ภาค${o}">`,e[o].forEach((function(o){t+=`<option value="${o.name}">${o.name}</option>`})),t+="</optgroup>");$("#province").html(t),$("#quickProvince").html(t),console.log(`โหลดข้อมูล ${o.total} จังหวัดเรียบร้อยแล้ว`)}else showNotification("ไม่สามารถโหลดข้อมูลจังหวัดได้","error")},error:function(){showNotification("เกิดข้อผิดพลาดในการโหลดจังหวัด","error"),$("#province").html('<option value="">ไม่สามารถโหลดจังหวัดได้</option>'),$("#quickProvince").html('<option value="">ไม่สามารถโหลดจังหวัดได้</option>')}})}function submitEvaluation(){const o={property_type:$("#propertyType").val(),location:$("#province").val(),area:$("#area").val(),bedrooms:$("#bedrooms").val(),bathrooms:$("#bathrooms").val(),age:$("#age").val(),condition:$("#condition").val(),additional_info:$("#additionalInfo").val()};o.property_type&&o.location&&o.area?($("#evaluationForm").hide(),$("#loading").show(),currentEvaluationData=o,$.ajax({url:"/api/evaluate",method:"POST",contentType:"application/json",data:JSON.stringify(o),timeout:12e4,success:function(o){o.success?(displayResult(o),showNotification("ประเมินราคาสำเร็จ","success")):showError(o.error||"เกิดข้อผิดพลาดในการประเมินราคา")},error:function(o){let t="ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้";o.responseJSON&&o.responseJSON.error&&(t=o.responseJSON.error),showError(t)},complete:function(){$("#loading").hide(),$("#evaluationForm").show()}})):showNotification("กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน","warning")}function submitQuickEstimate(){const o={property_type:$("#quickPropertyType").val(),area:$("#quickArea").val(),province:$("#quickProvince").val()};o.property_type&&o.area&&o.province?$.ajax({url:"/api/quick-estimate",method:"POST",contentType:"application/json",data:JSON.stringify(o),success:function(o){o.success?displayQuickResult(o):showNotification(o.error||"เกิดข้อผิดพลาด","error")},error:function(){showNotification("ไม่สามารถคำนวณราคาได้","error")}}):showNotification("กรุณากรอกข้อมูลให้ครบถ้วน","warning")}function displayResult(o){const t=o.property_data,e=o.evaluation;let n='<h4><i class="fas fa-home"></i> ข้อมูลทรัพย์สิน</h4>';n+='<div class="property-info">',t.property_type&&(n+=`\n            <div class="property-info-item">\n                <i class="fas fa-building"></i>\n                <span><strong>ประเภท:</strong> ${t.property_type}</span>\n            </div>\n        `),t.location&&(n+=`\n            <div class="property-info-item">\n                <i class="fas fa-map-marker-alt"></i>\n                <span><strong>ทำเล:</strong> ${t.location}</span>\n            </div>\n        `),t.area&&(n+=`\n            <div class="property-info-item">\n                <i class="fas fa-ruler-combined"></i>\n                <span><strong>ขนาด:</strong> ${t.area} ตร.ม.</span>\n            </div>\n        `),t.bedrooms&&(n+=`\n            <div class="property-info-item">\n                <i class="fas fa-bed"></i>\n                <span><strong>ห้องนอน:</strong> ${t.bedrooms} ห้อง</span>\n            </div>\n        `),t.bathrooms&&(n+=`\n            <div class="property-info-item">\n                <i class="fas fa-bath"></i>\n                <span><strong>ห้องน้ำ:</strong> ${t.bathrooms} ห้อง</span>\n            </div>\n        `),t.age&&(n+=`\n            <div class="property-info-item">\n                <i class="fas fa-calendar-alt"></i>\n                <span><strong>อายุ:</strong> ${t.age} ปี</span>\n            </div>\n        `),n+="</div>",$("#propertySummary").html(n),$("#resultContent").html(formatEvaluation(e)),$("#resultCard").fadeIn(500),$("html, body").animate({scrollTop:$("#resultCard").offset().top-100},800)}function formatEvaluation(o){let t=o.replace(/\n/g,"<br>");return t=t.replace(/(\d+[\d,]*\s*บาท)/g,'<strong style="color: var(--primary-color); font-size: 1.1em;">$1</strong>'),t=t.replace(/(ราคาประเมิน|ราคาโดยประมาณ)/gi,'<strong style="color: var(--success-color);">$1</strong>'),t}function displayQuickResult(o){const t=o.estimated_price,e=o.price_per_sqm,n=o.area,a=t.toLocaleString("th-TH",{minimumFractionDigits:0,maximumFractionDigits:0});let i=`${e.toLocaleString("th-TH",{minimumFractionDigits:0,maximumFractionDigits:0})} บาท/ตร.ม. × ${n} ตร.ม.`;o.province&&(i+=` | ${o.province}`),o.region&&(i+=` (ภาค${o.region})`),$("#quickPrice").text(a+" บาท"),$("#quickDetail").text(i),$("#quickResult").fadeIn(500)}function showNotification(o,t="info"){const e={success:"var(--success-color)",warning:"var(--warning-color)",error:"var(--danger-color)",info:"var(--primary-color)"},n=$(`\n        <div class="notification" style="\n            position: fixed;\n            top: 100px;\n            right: 20px;\n            background: white;\n            padding: 1rem 1.5rem;\n            border-radius: 8px;\n            box-shadow: var(--shadow-lg);\n            border-left: 4px solid ${e[t]};\n            z-index: 9999;\n            display: flex;\n            align-items: center;\n            gap: 0.75rem;\n            animation: slideInRight 0.3s ease;\n            min-width: 300px;\n        ">\n            <i class="fas ${{success:"fa-check-circle",warning:"fa-exclamation-triangle",error:"fa-times-circle",info:"fa-info-circle"}[t]}" style="color: ${e[t]}; font-size: 1.25rem;"></i>\n            <span style="flex: 1;">${o}</span>\n            <button onclick="$(this).parent().fadeOut(300, function() { $(this).remove(); })"\n                style="background: none; border: none; cursor: pointer; font-size: 1.25rem; color: var(--gray-color);">\n                <i class="fas fa-times"></i>\n            </button>\n        </div>\n    `);$("body").append(n),setTimeout((function(){n.fadeOut(300,(function(){$(this).remove()}))}),5e3)}function showError(o){showNotification(o,"error"),o.includes("Ollama")&&setTimeout((function(){showNotification("กรุณาตรวจสอบว่า Ollama กำลังทำงานที่ http://localhost:11434","info")}),500)}function scrollToEvaluate(){$("html, body").animate({scrollTop:$("#evaluate").offset().top-80},800)}function showQuickEstimate(){$("#quickEstimateModal").addClass("active")}function closeQuickEstimate(){$("#quickEstimateModal").removeClass("active"),$("#quickResult").hide(),$("#quickEstimateForm")[0].reset()}function closeResult(){$("#resultCard").fadeOut(300)}function resetForm(){$("#evaluationForm")[0].reset(),$("#resultCard").fadeOut(300),currentEvaluationData=null}function downloadPDF(){if(!currentEvaluationData)return void showNotification("ไม่มีข้อมูลการประเมิน","warning");showNotification("กำลังสร้าง PDF...","info");const o=$("#resultContent").text();fetch("/api/download-pdf",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({property_data:currentEvaluationData,evaluation:o})}).then((o=>{if(!o.ok)throw new Error("ไม่สามารถสร้าง PDF ได้");return o.blob()})).then((o=>{const t=window.URL.createObjectURL(o),e=document.createElement("a");e.href=t,e.download=`property_evaluation_${Date.now()}.pdf`,document.body.appendChild(e),e.click(),window.URL.revokeObjectURL(t),document.body.removeChild(e),showNotification("ดาวน์โหลด PDF สำเร็จ","success")})).catch((o=>{console.error("Error:",o),showNotification("เกิดข้อผิดพลาดในการดาวน์โหลด PDF","error")}))}function shareResult(){navigator.share&&currentEvaluationData?navigator.share({title:"ผลการประเมินราคาทรัพย์สิน - มั่นใจ",text:`ประเมินราคา${currentEvaluationData.property_type}ที่${currentEvaluationData.location}`,url:window.location.href}).catch((o=>{console.log("Error sharing:",o),copyToClipboard()})):copyToClipboard()}function copyToClipboard(){const o=window.location.href,t=$("<input>");$("body").append(t),t.val(o).select(),document.execCommand("copy"),t.remove(),showNotification("คัดลอก URL แล้ว","success")}function uploadExcelFile(){const o=document.getElementById("excelFileInput"),t=o.files[0];if(!t)return void showNotification("กรุณาเลือกไฟล์","warning");const e=t.name.split(".").pop().toLowerCase();if(!["xlsx","xls","csv"].includes(e))return void showNotification("รองรับเฉพาะไฟล์ .xlsx, .xls, .csv เท่านั้น","error");showNotification("กำลังอัปโหลดไฟล์...","info");const n=new FormData;n.append("file",t),fetch("/api/upload-price-data",{method:"POST",body:n}).then((o=>o.json())).then((t=>{t.success?(showNotification(`${t.message} (รวม ${t.total_records} รายการ)`,"success"),t.errors&&t.errors.length>0&&(console.warn("Upload errors:",t.errors),showNotification(`มี ${t.error_count} รายการที่ไม่สามารถอัปโหลดได้`,"warning")),o.value="",closeUploadModal()):showNotification(t.error||"เกิดข้อผิดพลาดในการอัปโหลด","error")})).catch((o=>{console.error("Error:",o),showNotification("เกิดข้อผิดพลาดในการอัปโหลด","error")}))}function downloadTemplate(){showNotification("กำลังดาวน์โหลด template...","info"),fetch("/api/download-template").then((o=>{if(!o.ok)throw new Error("ไม่สามารถดาวน์โหลดได้");return o.blob()})).then((o=>{const t=window.URL.createObjectURL(o),e=document.createElement("a");e.href=t,e.download="price_data_template.xlsx",document.body.appendChild(e),e.click(),window.URL.revokeObjectURL(t),document.body.removeChild(e),showNotification("ดาวน์โหลด template สำเร็จ","success")})).catch((o=>{console.error("Error:",o),showNotification("เกิดข้อผิดพลาดในการดาวน์โหลด","error")}))}function showUploadModal(){$("#uploadModal").addClass("active")}function closeUploadModal(){$("#uploadModal").removeClass("active"),$("#excelFileInput").val("")}$(document).ready((function(){loadProvinces(),checkOllamaStatus(),setupEventHandlers(),setInterval(checkOllamaStatus,3e4),$("#excelFileInput").on("change",(function(){const o=this.files[0]?this.files[0].name:"เลือกไฟล์ Excel หรือ CSV";$(this).siblings(".file-label").find("span").text(o)}))})),$(document).on("click",".modal",(function(o){$(o.target).hasClass("modal")&&$(this).removeClass("active")})),$(document).on("keydown",(function(o){"Escape"===o.key&&($(".modal").removeClass("active"),closeResult())}));